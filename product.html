<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail - Klarna Express Checkout</title>
    <link rel="stylesheet" href="/fonts/klarna-fonts.css">
    <style>
        body {
            font-family: 'Klarna Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #F9F8F5;
            color: #0B051D;
        }
        .product-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .product-header {
            margin-bottom: 2rem;
        }
        .back-link {
            color: #0B051D;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .product-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }
        .product-image {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #FFA8CD 0%, #FFE9F3 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #0B051D;
        }
        .product-info {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .product-title {
            font-family: 'Klarna Title', sans-serif;
            font-size: 2rem;
            margin: 0;
            color: #0B051D;
        }
        .product-price {
            font-family: 'Klarna Title', sans-serif;
            font-size: 2.5rem;
            color: #0B051D;
            margin: 0;
        }
        .product-description {
            line-height: 1.6;
            color: #5A5A5A;
        }
        #klarna-payment-button {
            width: 100%;
            min-height: 60px;
            display: block;
        }
        .footer {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #E0E0E0;
            text-align: center;
            color: #5A5A5A;
            font-size: 0.875rem;
        }
        .commit-hash {
            font-family: 'Klarna Mono', monospace;
            color: #0B051D;
            font-size: 0.75rem;
        }
        @media (max-width: 768px) {
            .product-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="product-container">
        <div class="product-header">
            <a href="/" class="back-link">
                ‚Üê Back to Demo Store
            </a>
        </div>
        
        <div class="product-content">
            <div class="product-image">
                üõçÔ∏è
            </div>
            
            <div class="product-info">
                <h1 class="product-title">Demo Product</h1>
                <p class="product-price" id="product-price">‚Ç¨15.90</p>
                <div class="product-description">
                    <p>This is a demo product for testing Klarna Express Checkout integration. The product details and pricing can be customized as needed.</p>
                </div>
                <div style="margin-top: 1.5rem;">
                    <label for="locale-select" style="display: block; margin-bottom: 0.5rem; color: #5A5A5A; font-size: 0.9rem;">Locale:</label>
                    <select id="locale-select" style="padding: 0.5rem; border: 1px solid #E0E0E0; border-radius: 4px; font-size: 1rem; width: 100%; max-width: 200px; background: white; color: #0B051D;">
                        <option value="en-GB" selected>en-GB</option>
                        <option value="en-US">en-US</option>
                        <option value="sv-SE">sv-SE</option>
                        <option value="no-NO">no-NO</option>
                        <option value="da-DK">da-DK</option>
                        <option value="fi-FI">fi-FI</option>
                        <option value="de-DE">de-DE</option>
                        <option value="nl-NL">nl-NL</option>
                        <option value="fr-FR">fr-FR</option>
                        <option value="es-ES">es-ES</option>
                        <option value="it-IT">it-IT</option>
                        <option value="pl-PL">pl-PL</option>
                    </select>
                </div>
                <div id="osm-placement" style="margin-top: 1.5rem;"></div>
                <div id="klarna-payment-button" style="margin-top: 1.5rem;"></div>
            </div>
        </div>
        
        <div class="footer">
            <div>Commit: <span id="commit-hash" class="commit-hash">Loading...</span></div>
        </div>
    </div>

    <script type="module">
        // Check if script is running in 1st-party context (not in iframe)
        // Klarna SDK requires 1st-party context for purchase flows to work correctly
        if (window.self !== window.top) {
            console.error('‚ùå Klarna SDK Error: Script is running inside an iframe. Klarna SDK must be loaded in 1st-party context.');
            alert('Error: This page cannot be loaded in an iframe. Please open it directly in your browser.');
            throw new Error('Klarna SDK cannot be initialized in iframe context');
        }

        console.log('‚úÖ Script is running in 1st-party context (not in iframe)');

        let Klarna = null;
        let currentLocale = 'en-GB';

        // Function to get selected locale
        function getSelectedLocale() {
            const select = document.getElementById('locale-select');
            return select ? select.value : 'en-GB';
        }

        // Function to initialize Klarna SDK with locale
        async function initializeKlarnaSDK(locale) {
            // If SDK is already initialized, don't reinitialize (causes custom element registration errors)
            if (Klarna) {
                console.log('‚ö†Ô∏è SDK already initialized. Locale cannot be changed without page reload.');
                return Klarna;
            }

            // Static client ID for testing
            const clientId = "klarna_test_client_WU5zKkEhV0hwdVopTUlUKTNjZUE4MHlHWG02RGRuS0osMWFmOTI2ZGUtYzZmMS00ZWQ1LTkxYWEtMjU4ODZhZWViZGJiLDEsM00xOFVLYjBSNUVRQlpQZEJyUW5RaExaMnNjNWFRbDhiZVNxbEVIU1AzTT0";

            // Initialize Klarna WebSDK
            const { KlarnaSDK } = await import("https://js.klarna.com/web-sdk/v2/klarna.mjs");

            Klarna = await KlarnaSDK({ 
                clientId: clientId,
                products: ["PAYMENT", "MESSAGING"], // Ensure products are properly specified for best performance
                locale: locale,
            });

            console.log('‚úÖ Klarna SDK initialized with locale:', locale);
            console.log('‚úÖ Products specified:', ["PAYMENT", "MESSAGING"]);
            return Klarna;
        }

        // Check for stored locale preference
        const storedLocale = sessionStorage.getItem('klarnaLocale');
        if (storedLocale) {
            currentLocale = storedLocale;
            const localeSelect = document.getElementById('locale-select');
            if (localeSelect) {
                localeSelect.value = storedLocale;
            }
        }

        // Initialize with default locale
        await initializeKlarnaSDK(currentLocale);

        // Function to mount Klarna on-site messaging placement
        // Note: Messaging may fail if domain is not whitelisted or client ID doesn't have messaging permissions
        // This is expected and won't affect the payment button functionality
        function mountMessagingPlacement() {
            if (Klarna?.Messaging?.placement) {
                try {
                    const placement = Klarna.Messaging.placement({
                        key: 'credit-promotion-badge',
                        locale: currentLocale,
                        amount: 1590
                    });
                    
                    // Add error handler for messaging placement
                    if (placement.on) {
                        placement.on('error', (error) => {
                            console.warn('‚ö†Ô∏è Klarna messaging placement error (expected if domain not whitelisted for messaging or client ID lacks messaging permissions):', error);
                        });
                    }
                    
                    placement.mount('#osm-placement');
                    console.log('‚úÖ Klarna messaging placement mounted');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error mounting messaging placement (expected if domain not whitelisted for messaging or client ID lacks messaging permissions):', error);
                }
            } else {
                console.warn('‚ö†Ô∏è Klarna.Messaging.placement not available');
            }
        }

        // Function to mount the button
        function mountKlarnaButton() {
            console.log('Attempting to mount Klarna button...');
            console.log('Klarna object:', Klarna);
            console.log('Klarna.Payment:', Klarna?.Payment);
            
            // Mount the button
            const buttonElement = document.getElementById('klarna-payment-button');
            console.log('Button element:', buttonElement);
            
            if (!buttonElement) {
                console.error('Button container not found');
                return;
            }

            if (!Klarna?.Payment?.button) {
                console.error('Klarna.Payment.button is not available');
                return;
            }

            // Create button configuration with initiate callback
            const buttonConfig = {
                intents: ["PAY"], // Fix the intents warning
                initiationMode: "ON_PAGE", // Keep payment flow on-page, not in new tab
                initiate: async () => {
                    console.log('Button initiate called - creating payment request server-side');
                    
                    try {
                        const resp = await fetch('/api/klarna/payment-request', {
                    method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                                currency: "EUR",
                                amount: 1590
                    })
                });

                        if (!resp.ok) {
                            const errorText = await resp.text();
                            console.error('Server error response:', errorText);
                            throw new Error('Failed to create payment request');
                        }
                        
                        const data = await resp.json();
                        console.log('Payment request created:', data.paymentRequestId);
                        
                        return { paymentRequestId: data.paymentRequestId };
                    } catch (error) {
                        console.error('Error creating payment request:', error);
                        throw error;
                    }
                }
            };

            console.log('Button configuration created:', buttonConfig);

            try {
                const klarnaPaymentButton = Klarna.Payment.button(buttonConfig);
                console.log('Button instance created:', klarnaPaymentButton);
                klarnaPaymentButton.mount('#klarna-payment-button');
                console.log('Klarna button mounted successfully');
            } catch (error) {
                console.error('Error mounting button:', error);
            }
        }

        // Mount button when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener("DOMContentLoaded", () => {
                mountMessagingPlacement();
                mountKlarnaButton();
                
                // Add locale change handler
                const localeSelect = document.getElementById('locale-select');
                if (localeSelect) {
                    localeSelect.addEventListener('change', async (e) => {
                        const newLocale = e.target.value;
                        console.log('Locale changed to:', newLocale);
                        
                        // Note: Klarna SDK locale is set during initialization and cannot be changed dynamically
                        // The locale affects the SDK initialization, so changing it requires a page reload
                        if (newLocale !== currentLocale) {
                            // Store locale preference and reload
                            sessionStorage.setItem('klarnaLocale', newLocale);
                            window.location.reload();
                        }
                    });
                }
            });
        } else {
            // DOM is already loaded
            mountMessagingPlacement();
            mountKlarnaButton();
            
            // Add locale change handler
            const localeSelect = document.getElementById('locale-select');
            if (localeSelect) {
                localeSelect.addEventListener('change', async (e) => {
                    const newLocale = e.target.value;
                    console.log('Locale changed to:', newLocale);
                    
                    // Note: Klarna SDK locale is set during initialization and cannot be changed dynamically
                    // The locale affects the SDK initialization, so changing it requires a page reload
                    if (newLocale !== currentLocale) {
                        // Store locale preference and reload
                        sessionStorage.setItem('klarnaLocale', newLocale);
                        window.location.reload();
                    }
                });
            }
        }

        // Load commit hash for deployment tracking
        async function loadCommitHash() {
            try {
                const response = await fetch('/api/commit');
                if (response.ok) {
                    const data = await response.json();
                    const commitEl = document.getElementById('commit-hash');
                    if (commitEl) {
                        commitEl.textContent = data.commit || 'unknown';
                    }
                }
            } catch (error) {
                console.error('Failed to load commit hash:', error);
                const commitEl = document.getElementById('commit-hash');
                if (commitEl) {
                    commitEl.textContent = 'unknown';
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadCommitHash();
        });
    </script>
</body>
</html>
