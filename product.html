<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail - Klarna Express Checkout</title>
    <link rel="stylesheet" href="/fonts/klarna-fonts.css">
    <style>
        body {
            font-family: 'Klarna Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #F9F8F5;
            color: #0B051D;
        }
        .product-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .product-header {
            margin-bottom: 2rem;
        }
        .back-link {
            color: #0B051D;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .product-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }
        .product-image {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #FFA8CD 0%, #FFE9F3 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #0B051D;
        }
        .product-info {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .product-title {
            font-family: 'Klarna Title', sans-serif;
            font-size: 2rem;
            margin: 0;
            color: #0B051D;
        }
        .product-price {
            font-family: 'Klarna Title', sans-serif;
            font-size: 2.5rem;
            color: #0B051D;
            margin: 0;
        }
        .product-description {
            line-height: 1.6;
            color: #5A5A5A;
        }
        #klarna-payment-button {
            width: 100%;
            min-height: 60px;
            display: block;
        }
        .footer {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #E0E0E0;
            text-align: center;
            color: #5A5A5A;
            font-size: 0.875rem;
        }
        .commit-hash {
            font-family: 'Klarna Mono', monospace;
            color: #0B051D;
            font-size: 0.75rem;
        }
        @media (max-width: 768px) {
            .product-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="product-container">
        <div class="product-header">
            <a href="/" class="back-link">
                ‚Üê Back to Demo Store
            </a>
        </div>
        
        <div class="product-content">
            <div class="product-image">
                üõçÔ∏è
            </div>
            
            <div class="product-info">
                <h1 class="product-title">Demo Product</h1>
                <p class="product-price" id="product-price">‚Ç¨15.90</p>
                <div class="product-description">
                    <p>This is a demo product for testing Klarna Express Checkout integration. The product details and pricing can be customized as needed.</p>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background-color: #F9F8F5; border: 1px solid #E0E0E0; border-radius: 4px;">
                    <label for="client-id-input" style="display: block; margin-bottom: 0.5rem; color: #5A5A5A; font-size: 0.9rem; font-weight: 600;">Klarna Client ID:</label>
                    <input 
                        type="text" 
                        id="client-id-input" 
                        placeholder="Enter your Klarna Client ID"
                        style="padding: 0.5rem; border: 1px solid #E0E0E0; border-radius: 4px; font-size: 0.9rem; width: 100%; max-width: 600px; background: white; color: #0B051D; font-family: 'Klarna Mono', monospace;"
                    />
                    <button 
                        id="init-sdk-button" 
                        style="margin-top: 0.5rem; padding: 0.5rem 1rem; background-color: #0B051D; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; font-weight: 500;"
                        onmouseover="this.style.backgroundColor='#1a1a2e'"
                        onmouseout="this.style.backgroundColor='#0B051D'"
                    >
                        Initialize Klarna SDK
                    </button>
                    <div id="sdk-status" style="margin-top: 0.5rem; font-size: 0.85rem; color: #5A5A5A;"></div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <label for="locale-select" style="display: block; margin-bottom: 0.5rem; color: #5A5A5A; font-size: 0.9rem;">Locale:</label>
                    <select id="locale-select" style="padding: 0.5rem; border: 1px solid #E0E0E0; border-radius: 4px; font-size: 1rem; width: 100%; max-width: 200px; background: white; color: #0B051D;">
                        <option value="en-GB" selected>en-GB</option>
                        <option value="en-US">en-US</option>
                        <option value="sv-SE">sv-SE</option>
                        <option value="no-NO">no-NO</option>
                        <option value="da-DK">da-DK</option>
                        <option value="fi-FI">fi-FI</option>
                        <option value="de-DE">de-DE</option>
                        <option value="nl-NL">nl-NL</option>
                        <option value="fr-FR">fr-FR</option>
                        <option value="es-ES">es-ES</option>
                        <option value="it-IT">it-IT</option>
                        <option value="pl-PL">pl-PL</option>
                    </select>
                </div>
                <div id="osm-placement" style="margin-top: 1.5rem;"></div>
                <div id="klarna-payment-button" style="margin-top: 1.5rem;"></div>
            </div>
        </div>
        
        <div class="footer">
            <div>Commit: <span id="commit-hash" class="commit-hash">Loading...</span></div>
        </div>
    </div>

    <script type="module">
        // Check if script is running in 1st-party context (not in iframe)
        // Klarna SDK requires 1st-party context for purchase flows to work correctly
        if (window.self !== window.top) {
            console.error('‚ùå Klarna SDK Error: Script is running inside an iframe. Klarna SDK must be loaded in 1st-party context.');
            alert('Error: This page cannot be loaded in an iframe. Please open it directly in your browser.');
            throw new Error('Klarna SDK cannot be initialized in iframe context');
        }

        console.log('‚úÖ Script is running in 1st-party context (not in iframe)');

        let Klarna = null;
        let currentLocale = 'en-GB';
        let currentClientId = null;

        // Function to get selected locale
        function getSelectedLocale() {
            const select = document.getElementById('locale-select');
            return select ? select.value : 'en-GB';
        }

        // Function to get client ID from input or storage
        function getClientId() {
            const input = document.getElementById('client-id-input');
            if (input && input.value.trim()) {
                return input.value.trim();
            }
            // Fallback to stored client ID
            return sessionStorage.getItem('klarnaClientId') || null;
        }

        // Function to update SDK status message
        function updateSDKStatus(message, isError = false) {
            const statusEl = document.getElementById('sdk-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.color = isError ? '#D32F2F' : '#2E7D32';
            }
        }

        // Function to initialize Klarna SDK with locale and client ID
        async function initializeKlarnaSDK(locale, clientId) {
            if (!clientId) {
                updateSDKStatus('‚ö†Ô∏è Please enter a Klarna Client ID', true);
                throw new Error('Client ID is required');
            }

            // If SDK is already initialized with the same client ID, don't reinitialize
            if (Klarna && currentClientId === clientId) {
                console.log('‚ö†Ô∏è SDK already initialized with this Client ID. Locale cannot be changed without page reload.');
                updateSDKStatus('‚úÖ SDK already initialized');
                return Klarna;
            }

            // If client ID changed, we need to reload the page to reinitialize
            if (Klarna && currentClientId !== clientId) {
                console.log('‚ö†Ô∏è Client ID changed. Page reload required to reinitialize SDK.');
                updateSDKStatus('‚ö†Ô∏è Client ID changed. Reloading page...', true);
                sessionStorage.setItem('klarnaClientId', clientId);
                window.location.reload();
                return;
            }

            // Log the current origin - this is what Klarna sees for domain whitelisting
            console.log('üåê Current origin (what Klarna sees for whitelisting):', window.location.origin);
            console.log('üåê Current hostname:', window.location.hostname);
            console.log('üåê Full URL:', window.location.href);

            console.log('üîë Using Client ID:', clientId);
            console.log('‚ö†Ô∏è Make sure this Client ID is whitelisted for:', window.location.origin);

            updateSDKStatus('üîÑ Initializing Klarna SDK...');

            try {
                // Initialize Klarna WebSDK
                const { KlarnaSDK } = await import("https://js.klarna.com/web-sdk/v2/klarna.mjs");

                Klarna = await KlarnaSDK({ 
                    clientId: clientId,
                    products: ["PAYMENT", "MESSAGING"], // Ensure products are properly specified for best performance
                    locale: locale,
                });

                currentClientId = clientId;
                
                // Store client ID in sessionStorage
                sessionStorage.setItem('klarnaClientId', clientId);

                console.log('‚úÖ Klarna SDK initialized with locale:', locale);
                console.log('‚úÖ Products specified:', ["PAYMENT", "MESSAGING"]);
                
                updateSDKStatus('‚úÖ SDK initialized successfully');
                
                // Mount components after successful initialization
                mountMessagingPlacement();
                mountKlarnaButton();
                
                return Klarna;
            } catch (error) {
                console.error('‚ùå Failed to initialize Klarna SDK:', error);
                updateSDKStatus(`‚ùå Error: ${error.message}`, true);
                throw error;
            }
        }

        // Check for stored preferences
        const storedLocale = sessionStorage.getItem('klarnaLocale');
        if (storedLocale) {
            currentLocale = storedLocale;
            const localeSelect = document.getElementById('locale-select');
            if (localeSelect) {
                localeSelect.value = storedLocale;
            }
        }

        // Load stored client ID
        const storedClientId = sessionStorage.getItem('klarnaClientId');
        if (storedClientId) {
            const clientIdInput = document.getElementById('client-id-input');
            if (clientIdInput) {
                clientIdInput.value = storedClientId;
            }
        }

        // Initialize SDK button handler
        document.addEventListener('DOMContentLoaded', () => {
            const initButton = document.getElementById('init-sdk-button');
            const clientIdInput = document.getElementById('client-id-input');
            
            if (initButton) {
                initButton.addEventListener('click', async () => {
                    const clientId = getClientId();
                    if (!clientId) {
                        updateSDKStatus('‚ö†Ô∏è Please enter a Klarna Client ID', true);
                        return;
                    }
                    
                    try {
                        await initializeKlarnaSDK(currentLocale, clientId);
                    } catch (error) {
                        console.error('Failed to initialize SDK:', error);
                    }
                });
            }

            // Allow Enter key to initialize
            if (clientIdInput) {
                clientIdInput.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const clientId = getClientId();
                        if (clientId) {
                            try {
                                await initializeKlarnaSDK(currentLocale, clientId);
                            } catch (error) {
                                console.error('Failed to initialize SDK:', error);
                            }
                        }
                    }
                });
            }

            // Auto-initialize if client ID is already stored
            if (storedClientId) {
                console.log('üîÑ Auto-initializing with stored Client ID...');
                initializeKlarnaSDK(currentLocale, storedClientId).catch(error => {
                    console.error('Auto-initialization failed:', error);
                });
            } else {
                updateSDKStatus('‚ö†Ô∏è Enter a Klarna Client ID and click "Initialize Klarna SDK"');
            }
        });

        // Function to mount Klarna on-site messaging placement
        // Note: Messaging may fail if domain is not whitelisted or client ID doesn't have messaging permissions
        // This is expected and won't affect the payment button functionality
        function mountMessagingPlacement() {
            if (Klarna?.Messaging?.placement) {
                try {
                    const placement = Klarna.Messaging.placement({
                        key: 'credit-promotion-badge',
                        locale: currentLocale,
                        amount: 1590
                    });
                    
                    // Add error handler for messaging placement
                    if (placement.on) {
                        placement.on('error', (error) => {
                            console.warn('‚ö†Ô∏è Klarna messaging placement error (expected if domain not whitelisted for messaging or client ID lacks messaging permissions):', error);
                        });
                    }
                    
                    placement.mount('#osm-placement');
                    console.log('‚úÖ Klarna messaging placement mounted');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error mounting messaging placement (expected if domain not whitelisted for messaging or client ID lacks messaging permissions):', error);
                }
            } else {
                console.warn('‚ö†Ô∏è Klarna.Messaging.placement not available');
            }
        }

        // Function to mount the button
        function mountKlarnaButton() {
            console.log('Attempting to mount Klarna button...');
            console.log('Klarna object:', Klarna);
            console.log('Klarna.Payment:', Klarna?.Payment);
            
            // Mount the button
            const buttonElement = document.getElementById('klarna-payment-button');
            console.log('Button element:', buttonElement);
            
            if (!buttonElement) {
                console.error('Button container not found');
                return;
            }

            if (!Klarna?.Payment?.button) {
                console.error('Klarna.Payment.button is not available');
                return;
            }

            // Create button configuration with initiate callback
            // Matching the pattern from Val Town demo and kec-index.js
            // The initiate callback returns the payment request configuration directly (not async)
            const buttonConfig = {
                intents: ["PAY"],
                initiationMode: "ON_PAGE", // Changed from DEVICE_BEST to match working examples
                locale: currentLocale, // Set button locale to match SDK initialization locale
                // According to Klarna WebSDK docs and working examples:
                // initiate can return PaymentRequestData directly (not async Promise)
                // https://docs.klarna.com/websdk/v2/interfaces/payment.KlarnaPaymentButtonConfig.html#initiate
                initiate: () => {
                    console.log('Button initiate called - returning PaymentRequestData');
                    console.log('Current origin:', window.location.origin);
                    
                    // Generate unique references
                    const paymentRef = `pay-ref-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    // Get return URL (use current origin)
                    // Using camelCase paymentRequest format to match working examples
                    const returnUrl = `${window.location.origin}/payment-success?id={klarna.paymentRequest.id}&token={klarna.paymentRequest.payment_token}`;
                    
                    // PaymentRequestData structure matching Val Town demo pattern
                    const paymentRequestData = {
                        currency: "EUR",
                        amount: 1590,
                        shippingConfig: {
                            mode: "EDITABLE"
                        },
                        collectCustomerProfile: [
                            "profile:email",
                            "profile:name",
                            "profile:phone",
                            "profile:billing_address"
                        ],
                        supplementaryPurchaseData: {
                            lineItems: [
                                {
                                    name: "Demo Product",
                                    quantity: 1,
                                    totalAmount: 1590
                                }
                            ]
                        },
                        customerInteractionConfig: {
                            returnUrl: returnUrl
                        }
                    };
                    
                    console.log('üì§ Returning PaymentRequestData to WebSDK:', JSON.stringify(paymentRequestData, null, 2));
                    
                    // Return PaymentRequestData directly (not async Promise)
                    return paymentRequestData;
                }
            };

            console.log('Button configuration created:', buttonConfig);

            try {
                const klarnaPaymentButton = Klarna.Payment.button(buttonConfig);
                console.log('Button instance created:', klarnaPaymentButton);
                
                // Add event listeners to track button behavior
                if (klarnaPaymentButton.on) {
                    klarnaPaymentButton.on('error', (error) => {
                        console.error('‚ùå Klarna button error event:', error);
                        console.error('Error details:', JSON.stringify(error, null, 2));
                    });
                    
                    klarnaPaymentButton.on('complete', (paymentRequest) => {
                        console.log('‚úÖ Klarna button complete event:', paymentRequest);
                        console.log('üìã Full payment request data:', JSON.stringify(paymentRequest, null, 2));
                        
                        // Extract interoperability_token from stateContext
                        // This token is needed to send to Paytrail for Klarna network integration
                        const interoperabilityToken = paymentRequest?.stateContext?.interoperabilityToken;
                        
                        if (interoperabilityToken) {
                            console.log('üîë Interoperability Token:', interoperabilityToken);
                            
                            // Store in sessionStorage for later use (e.g., sending to Paytrail)
                            try {
                                sessionStorage.setItem('klarnaInteroperabilityToken', interoperabilityToken);
                                console.log('‚úÖ Interoperability token stored in sessionStorage');
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Unable to store interoperability token:', e);
                            }
                            
                            // TODO: Send interoperability_token to Paytrail API
                            // The token should be sent as: providerDetails.klarna.networkSessionToken
                            // Example: { providerDetails: { klarna: { networkSessionToken: interoperabilityToken } } }
                        } else {
                            console.warn('‚ö†Ô∏è No interoperability_token found in payment request stateContext');
                        }
                    });
                    
                    klarnaPaymentButton.on('shippingaddresschange', (data) => {
                        console.log('üìç Shipping address change:', data);
                    });
                    
                    klarnaPaymentButton.on('shippingoptionselect', (data) => {
                        console.log('üöö Shipping option select:', data);
                    });
                }
                
                klarnaPaymentButton.mount('#klarna-payment-button');
                console.log('‚úÖ Klarna button mounted successfully');
            } catch (error) {
                console.error('‚ùå Error mounting button:', error);
                updateSDKStatus(`‚ùå Error mounting button: ${error.message}`, true);
            }
        }

        // Add locale change handler (mounting happens after SDK initialization)
        function setupLocaleChangeHandler() {
            const localeSelect = document.getElementById('locale-select');
            if (localeSelect) {
                localeSelect.addEventListener('change', async (e) => {
                    const newLocale = e.target.value;
                    console.log('Locale changed to:', newLocale);
                    
                    // Note: Klarna SDK locale is set during initialization and cannot be changed dynamically
                    // The locale affects the SDK initialization, so changing it requires a page reload
                    if (newLocale !== currentLocale) {
                        // Store locale preference and reload
                        sessionStorage.setItem('klarnaLocale', newLocale);
                        window.location.reload();
                    }
                });
            }
        }

        // Setup locale handler when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener("DOMContentLoaded", () => {
                setupLocaleChangeHandler();
            });
        } else {
            // DOM is already loaded
            setupLocaleChangeHandler();
        }

        // Load commit hash for deployment tracking
        async function loadCommitHash() {
            try {
                const response = await fetch('/api/commit');
                if (response.ok) {
                    const data = await response.json();
                    const commitEl = document.getElementById('commit-hash');
                    if (commitEl) {
                        commitEl.textContent = data.commit || 'unknown';
                    }
                }
            } catch (error) {
                console.error('Failed to load commit hash:', error);
                const commitEl = document.getElementById('commit-hash');
                if (commitEl) {
                    commitEl.textContent = 'unknown';
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadCommitHash();
        });
    </script>
</body>
</html>
